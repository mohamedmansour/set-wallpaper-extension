<!DOCTYPE html>
<html>
<title>Set Wallpaper</title>
<link rel="stylesheet" type="text/css" href="/css/preview.css" />
<script type='text/javascript' src='/js/shared.js'></script>
<script type='text/javascript' src='/js/position_enum.js'></script>
<script type='text/javascript' src='/js/dimension.js'></script>
<script type='text/javascript' src='/js/wallpaper_preview.js'></script>
<body onLoad="init();">
  <h1>TESTING!</h1>
  <div id="area">
    <div id="preview">
      <canvas id="canvas" width="540" height="304" ></canvas>
    </div>
    <div id="options">
      <ul>
        <li onClick="changeSelection(this, PositionEnum.STRETCH);"
            class="selected" id="stretchButton">Stretch</li>
        <li onClick="changeSelection(this, PositionEnum.TILE);"
            id="tileButton">Tile</li>
        <li onClick="changeSelection(this, PositionEnum.CENTER);"
            id="centerButton">Center</li>
      </ul>
    </div>
  </div>
  <div id="buttons">
    <a class="green button" onclick="doSubmit();">Set wallpaper</a>
    <a class="orange button" onclick="doOptions();">Options</a>
    <a class="yellow button" onclick="doClose();">Close</a>
  </div>
  <embed type="application/x-vnd-set-wallpaper" id="pluginobj"
         width="0" height="0" />
  <script>
  // Initialize the plugin.
  var app = document.getElementById("pluginobj");
  var bkg = chrome.extension.getBackgroundPage();
  var preview = null;
  
  /**
   * Initialize the previewer.
   */
  function init() {
    var imageURL = window.location.hash.substring(1);
    preview = new WallpaperPreview('canvas', imageURL, PositionEnum.STRETCH);
    try {
      app.debug = bkg.settings.debug;
      var hex = app.systemColor();
      preview.setCanvasBackground(hex);
    }
    catch (e) {
      alert('An error occured while grabbing your system color, please inform' +
            ' the developer. Visit the extension page for more info.');
    }
  }
  
  /**
   * Change the selection of the wallpaper style.
   * @param {HTMLElement} dom The current list item.
   * @param {Object<PositionEnum>} position The wallpaper position to set.
   */
  function changeSelection(dom, position) {
    var lists = document.getElementsByTagName('li');
    for (var i in lists) {
      var list = lists[i];
      list.className = '';
    }
    dom.className = 'selected';
    preview.render(position);
  }
  
  /**
   * Submit a request to change the wallpaper.
   */
  function doSubmit() {
    try {
      var position = preview.getPosition();
      app.setWallpaper(preview.getImageURL(), position.style, position.tile);
    }
    catch (e) {
      alert('An error occured while setting the wallpaper, please inform' +
            ' the developer. Visit the extension page for more info.');
    }
  }
  
  /**
   * Open a singleton page, which means, if a page already exists, it just selects it.
   * @param url The page which it will navigate to.
   */
  function openSingletonPage(url, callback) {
    chrome.windows.getCurrent(function(win) {
      chrome.tabs.getAllInWindow(win.id, function(tabs) {
        // Check if the page is already open.
        for (var i = 0; i < tabs.length; i++) {
          // If the page exists, just select it.
          if (tabs[i].url.indexOf(url) == 0) {
            chrome.tabs.update(tabs[i].id, {selected: true});
            return;
          }
        }
        chrome.tabs.create({url: url});
      });
    });
  }
  
  /**
   * Close the preview.
   */
  function doClose() {
    window.close();  
  }
  
  function doOptions() {
    openSingletonPage(chrome.extension.getURL('options.html'));
  }
  </script>
</body>
</html>