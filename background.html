<!DOCTYPE html> 
<html>
<script>

// Settings.
settings = {
  get version() {
    return localStorage['version'];
  },
  set version(val) {
    localStorage['version'] = val;
  },
  get debug() {
    var key = localStorage['debug'];
    return (typeof key == 'undefined') ? false : key === 'true';
  },
  set debug(val) {
    localStorage['debug'] = val;
  },
};

/**
 * Get the version number from the manifest.
 *
 * @returns {string} The current version number.
 */
function getVersion() {
  var version = 'NaN';
  var xhr = new XMLHttpRequest();
  xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
  xhr.send(null);
  var manifest = JSON.parse(xhr.responseText);
  return manifest.version;
}

/**
 * Sanitize the url to remove all the query string params.
 * @param {string} url The image url that need sanitization.
 * @return {string} The cleaned url.
 */
function sanitizeURL(url) {
  return url.split('?')[0];
}

/**
 * Callback when the context menu was clicked.
 *
 * @param {Object} info The context menu info.
 * @param {Object<Tab>} tab The tab that it was triggered.
 */
function onImage(info, tab) {
  var url = 'preview.html#' + info.srcUrl;
  var index = tab.index + 1;
  chrome.tabs.create({url: sanitizeURL(url), index: index});
}


function init() {
  // Check if the version has changed. In case we want to do something in the
  // future.
  var currVersion = getVersion();
  var prevVersion = settings.version
  if (currVersion != prevVersion) {
    // Check if we just installed this extension.
    if (typeof prevVersion == 'undefined') {
      // Do nothing now.
    }
    // Update the version incase we want to do something in future.
    settings.version = currVersion;
  }
  
  // Install context menus on images.
  chrome.contextMenus.create({
    title: 'Set image as wallpaper',
    contexts: ['image'],
    onclick: onImage
  });
}


init();
</script>
</html>